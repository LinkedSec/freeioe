{% layout="base.html" %}
{-main_header-}
{-main_header-}

{-main-}
<h1 class="header"> {{_("Installed Application List")}} </h1>

{(widget/app_list.html, {apps=apps})}

<div class="ui icon message">
	<i class="inbox icon"></i>
	<div class="content">
		<div class="header">
			<div id="message_ui">
				{{ message }}
			</div>
		</div>
	</div>
</div>
{-main-}

{-script-}
<script>
function refresh_page() {
	window.location.replace("/app");
}
function upgrade_app(inst, app, version, beta) {
	$.post("/app/upgrade", {from_web:true, inst:inst, app:app, version:version, beta:beta}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 10000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send upgrade request")}}</i>');
	});
}
function uninstall_app(inst) {
	$.post("/app/uninstall", {from_web:true, inst:inst}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 3000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send uninstall request")}}</i>');
	});
}

function start_app(inst) {
	$.post("/app/start", {from_web:true, inst:inst}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 3000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send start request")}}</i>');
	});
}

function stop_app(inst) {
	$.post("/app/stop", {from_web:true, inst:inst, reason:'Stop from web'}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 3000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send stop request")}}</i>');
	});
}

function check_app_update(inst, app) {
	$.get("/app/check_update", {from_web:true, inst:inst, app:app}, function(data) {
		if (data && data.version) {
			var html = [
				'<div class="ui labeled button" onclick="upgrade_app(\''+inst+'\', \''+app+'\', \''+data.version+'\', false);">',
				'<div class="ui orange button">',
				'<i class="info circle icon"></i> {{_("Upgrade To")}}',
				'</div>',
				'<a class="ui basic orange left pointing label">',
				data.version,
				'</a>',
				'</div>',
			].join("\r\n");
			$('#'+inst+'_actions').prepend(html);
		};
		if (data && data.beta) {
			var html = [
				'<div class="ui labeled button" onclick="upgrade_app(\''+inst+'\', \''+app+'\', \''+data.beta+'\', true);">',
				'<div class="ui orange button">',
				'<i class="info circle icon"></i> {{_("Upgrade To")}}',
				'</div>',
				'<a class="ui basic orange left pointing label">',
				{{_("Beta")}} data.beta,
				'</a>',
				'</div>',
			].join("\r\n");
			$('#'+inst+'_actions').prepend(html);
		};
	})
	.done(function() {
	})
	.fail(function() {
	});
}

$(document).ready(function(){
	{% for k, v in pairs(apps) do %}
	check_app_update('{{k}}', '{{v.name}}');
	{% end %}
});
</script>
{-script-}
