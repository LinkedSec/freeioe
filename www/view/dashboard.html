{% layout="base.html" %}
{-main_header-}
{-main_header-}

{-main-}
<h1 class="header"> {{_("IOT System DashBoard")}}</h1>

<h3 class="ui top attached header">
	{{_("Information")}}
</h3>
<div class="ui attached basic segment">
	<div class="ui teal statistic">
		<div id="iot_version" class="value">
			{{version.iot.ver}}
		</div>
		<div class="label">
			{{_("Version")}}
		</div>
	</div>
	<div class="ui teal statistic">
		<div id="skynet_version" class="value">
			{{version.skynet.ver}}
		</div>
		<div class="label">
			{{_("Skynet Version")}}
		</div>
	</div>
	<div class="ui black statistic">
		<div class="value">
			{{platform}}
		</div>
		<div class="label">
			{{_("Platform")}}
		</div>
	</div>
	<div class="ui blue statistic">
		<div class="value">
			{{mem_info.total}}
		</div>
		<div class="label">
			{{_("Total Memory")}}
		</div>
	</div>
	{% if rollback_time then %}
	<div class="ui orange statistic">
		<div class="value">
			{{rollback_time}}
		</div>
		<div class="label">
			{{_("Rollback Time")}}
		</div>
	</div>
	{% end %}
</div>

<h3 class="ui top attached header">
	{{_("System Control")}}
</h3>
<div class="ui attached basic segment">
	<div id="mydimmer" class="ui disabled dimmer">
		<div class="ui massive text loader" id="myloader">{{_("Loading")}}</div>
	</div>

	{% if rollback_time then %}
	<div class="ui teal button" onclick="upgrade_ack();">{{_("Upgrade ACK")}}</div>
	{% else %}
	{% if using_beta then %}
	<div class="ui upgrade checkbox">
		<input id="check_with_beta" type="checkbox">
		<label>{{_("Check Beta")}}</label>
	</div>
	{% end %}
	<div id="check_for_update_btn" class="ui teal button" onclick="check_for_update();">{{_("Check Updates")}}</div>
	{% end %}
	<div class="ui purple button" onclick="sys_quit();">{{_("Restart")}}</div>
	<div class="ui red button" onclick="sys_reboot();">{{_("Device Reboot")}}</div>
</div>

{% if force_upgrade then %}
<div class="ui upgrade attached basic segment">
{% else %}
<div class="ui upgrade attached basic segment" hidden="true">
{% end %}
	<h4 class="ui header">
		{{_("System Upgrade")}}
	</h4>
	<div class="ui upgrade checkbox">
		<input id="upgrade_ack" type="checkbox">
		<label>{{_("Skip Ack?")}}</label>
	</div>
	<div class="ui upgrade skynet checked checkbox">
		<input id="with_skynet" type="checkbox" checked="true">
		<label id="skynet_version_label">{{_("With Skynet?")}}</label>
	</div>
	<div class="ui upgrade labeled button" onclick="upgrade_sys();">
		<div class="ui yellow button">
			<i class="info circle icon"></i> {{_("Upgrade To")}}
		</div>
		<a id="iot_version_label" class="ui basic yellow left pointing label">
			Latest
		</a>
	</div>
</div>

<div class="ui basic segment">
	<div class="ui computer only grid">
		<table class="ui striped basic table">
			<thead>
				<tr>
					<th colspan="2"><h3 class="ui header">{{_("More Information")}}</h3></th>
				</tr>
				<tr>
					<th>{{_("Name")}}</th>
					<th>{{_("Value")}}</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>{{_("Git Version")}} </td>
					<td>{{version.iot.git_ver}}</td>
				</tr>
				<tr>
					<td>{{_("Skynet Git Version")}} </td>
					<td>{{version.skynet.git_ver}}</td>
				</tr>
				<tr>
					<td>{{_("CPU Model")}} </td>
					<td>{{cpu_model}}</td>
				</tr>
				<tr>
					<td>{{_("UNAME")}} </td>
					<td>{{uname}}</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

<div class="ui icon message">
	<i class="inbox icon"></i>
	<div class="content">
		<div class="header">
			<div id="message_ui">
				{{ message }}
			</div>
		</div>
	</div>
</div>


{-main-}

{-script-}
<script>
function refresh_page() {
	//window.location.reload();
	window.location.replace("/dashboard");
}
function loader_test() {
	//var loader = $('#myloader');
	var loader = $('#mydimmer');
	loader.removeClass('disabled');
	loader.addClass('active');
}
var upgrade_version = 'latest';
var upgrade_skynet_version = 'latest';
function upgrade_sys() {
	var no_ack = $('#upgrade_ack').is(':checked');
	var with_skynet = $('#with_skynet').is(':checked');
	$.post("/sys/upgrade", {from_web:true, version:upgrade_version, no_ack:no_ack, skynet:with_skynet, skynet_version:upgrade_skynet_version}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 10000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send system upgrade request")}} </i>');
	});
}
function upgrade_ack() {
	$.post("/sys/upgrade_ack", {from_web:true}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 3000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send system upgrade ack request")}} </i>');
	});
}
function sys_reboot() {
	$.post("/sys/reboot", {from_web:true}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 20000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send device reboot request")}} </i>');
	});
}
function sys_quit() {
	$.post("/sys/quit", {from_web:true}, function(data) {
		$('#message_ui').html('<i>' + data + '</i>');
	})
	.done(function() {
		setTimeout('refresh_page()', 3000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to send system restart request")}} </i>');
	});
}
function check_iot_version() {
	$.get("/sys/check_version", {from_web:true, version:{{version.iot.ver}}, skynet_version:{{version.skynet.ver}} }, function(data) {
		if (data && data.iot) {
			if (data.iot == "release") {
				$('#iot_version').html('{{version.iot.ver}} <i class="green check icon"></i>');
			} else if (data.iot == "beta") {
				$('#iot_version').html('{{version.iot.ver}} <i class="yellow warning sign icon"></i>');
			} else {
				$('#iot_version').html('{{version.iot.ver}} <i class="red close icon"></i>');
			}
		};
		if (data && data.skynet) {
			if (data.skynet == "release") {
				$('#skynet_version').html('{{version.skynet.ver}} <i class="green check icon"></i>');
			} else if (data.skynet == "beta") {
				$('#skynet_version').html('{{version.skynet.ver}} <i class="yellow warning sign icon"></i>');
			} else {
				$('#skynet_version').html('{{version.skynet.ver}} <i class="red close icon"></i>');
			}
		};
	})
	.done(function() {
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to check system version")}} </i>');
	});
}
function enable_update_btn() {
	$('#check_for_update_btn').removeClass('disabled');
}
function check_for_update() {
	$('#check_for_update_btn').addClass('disabled');
	$('.ui.upgrade.segment').attr('hidden', true);
	$('#message_ui').html('');

	check_iot_version();

	var beta = $('#check_with_beta').is(':checked');
	var version = {{version.iot.ver}};
	var skynet_version = {{version.skynet.ver}};
	$.get("/sys/check_update", {from_web:true, beta:beta}, function(data) {
		if (data && data.iot) {
			if (data.iot.version > version) {
				$('.ui.upgrade.segment').attr('hidden', false);
			} else {
				$('#message_ui').html('<i>{{_("There is no new system updates")}} </i>');
			}
			upgrade_version = data.iot.version;
			if (data.iot.beta) {
				upgrade_version = "beta." + upgrade_version
			}
			$('#iot_version_label').html(upgrade_version);
		}
		if (data && data.skynet) {
			if (data.skynet.version > skynet_version) {
				$('.ui.upgrade.skynet.checkbox').checkbox('check');
				$('.ui.upgrade.skynet.checkbox').removeClass('disabled');
			} else {
				$('.ui.upgrade.skynet.checkbox').checkbox('uncheck');
				$('.ui.upgrade.skynet.checkbox').addClass('disabled');
			}
			upgrade_skynet_version = data.skynet.version;
			if (data.skynet.beta) {
				upgrade_skynet_version = "beta." + upgrade_skynet_version
			}
			$('#skynet_version_label').html('With Skynet ' + upgrade_skynet_version);
		}
	})
	.done(function() {
		setTimeout('enable_update_btn();', 3000);
	})
	.fail(function() {
		$('#message_ui').html('<i>{{_("Failed to check system updates")}} </i>');
	});
}
</script>
{-script-}
